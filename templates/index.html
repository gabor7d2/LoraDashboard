<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LoRa Central Dashboard</title>
    <!-- Bootstrap CSS via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    @keyframes new-message-flash {
        0%   { background-color: #71a3ee; }
        50%  { background-color: #71a3ee; }
        100% { background-color: transparent; }
    }
    tr.new-message, td.new-message {
        animation-name: new-message-flash;
        animation-duration: 10s;
    }
    /* Floating card style for tables */
    .floating-card {
        border: none;
        border-radius: 1rem;
        box-shadow: 0 4px 24px rgba(0,0,0,0.10), 0 1.5px 4px rgba(0,0,0,0.08);
        background: #fff;
        overflow: hidden;
    }
    .table {
        margin-bottom: 0;
        background: transparent;
    }
    .table thead th {
        border: none;
        background: #f8f9fa;
    }
    .table tbody tr {
        border: none;
    }
    .table tbody tr:hover {
        background: #f1f5fb;
    }
    .table td, .table th {
        border: none;
    }
    .team-checkbox {
        pointer-events: none;
    }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="card p-4 text-center shadow-sm">
            {% if user %}
                <h2 class="mb-1">Central Dashboard</h2>
                <h4 class="mb-4" style="color: gray;">Logged in as {{ user.name }} ({{ user.email }})</h4>
                <h4 class="mb-4" style="color: gray;">Debug info: {{ user }})</h4>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                    <a href="/qr" class="btn btn-primary">QR Key Generator</a>
                    <a href="/logout" class="btn btn-outline-danger">Logout</a>
                </div>
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="floating-card p-0">
                            <table class="table table-hover align-middle w-100">
                                <thead class="table-light">
                                    <tr>
                                        <th colspan="2"><h4>Teams</h4></th>
                                    </tr>
                                </thead>
                                <tbody id="team-selector">
                                    {% for team in teams %}
                                    <tr class="team-selector-row" data-team-id="{{ team.teamId }}">
                                        <td class="text-center">
                                            <input class="form-check-input team-checkbox" type="checkbox" value="{{ team.teamId }}" id="team-{{ team.teamId }}" checked>
                                        </td>
                                        <td>{{ team.teamName }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="floating-card p-0">
                            <table class="table table-striped align-middle w-100">
                                <thead class="table-light">
                                    <tr>
                                        <th colspan="3"><h4>Messages</h4></th>
                                    </tr>
                                    <tr>
                                        <th scope="col">Timestamp</th>
                                        <th scope="col">Sender</th>
                                        <th scope="col">Message</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% else %}
                <h2 class="mb-3">Welcome!</h2>
                <a href="/login" class="btn btn-success">Login</a>
            {% endif %}
        </div>
    </div>
<script>
{% if user %}
    let lastCount = null; // null means first fetch

    function updateMessages() {
        fetch('/messages')
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('div.col-md-9 tbody');
                const newCount = data.length;
                if (lastCount === null) {
                    // First fetch: render all messages in reverse order (newest at top)
                    for (let i = data.length - 1; i >= 0; i--) {
                        const msg = data[i];
                        const row = document.createElement('tr');
                        ['timestamp', 'sender', 'message'].forEach(key => {
                            const td = document.createElement('td');
                            td.textContent = msg[key];
                            row.appendChild(td);
                        });
                        tbody.appendChild(row);
                    }
                } else {
                    // Only add new messages with animation, oldest new at top
                    for (let i = lastCount; i < newCount; i++) {
                        const msg = data[i];
                        const row = document.createElement('tr');
                        row.classList.add('new-message');
                        ['timestamp', 'sender', 'message'].forEach(key => {
                            const td = document.createElement('td');
                            td.textContent = msg[key];
                            td.classList.add('new-message');
                            row.appendChild(td);
                        });
                        if (tbody.firstChild) {
                            tbody.insertBefore(row, tbody.firstChild);
                        } else {
                            tbody.appendChild(row);
                        }
                    }
                }
                lastCount = newCount;
            });
    }
    setInterval(updateMessages, 5000);
    updateMessages();

    // Make team selector rows clickable
    document.querySelectorAll('.team-selector-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // Prevent double toggling if checkbox is clicked directly
            if (e.target.tagName.toLowerCase() === 'input') return;
            const checkbox = this.querySelector('.team-checkbox');
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        });
    });

    // Team selector event listener
    document.querySelectorAll('.team-checkbox').forEach(cb => {
        cb.addEventListener('change', () => {
            const selected = Array.from(document.querySelectorAll('.team-checkbox:checked')).map(cb => cb.value);
            console.log('Selected teams:', selected);
        });
    });
{% endif %}
</script>
</body>
</html>